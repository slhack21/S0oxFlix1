<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>S0oxFlix</title>
  <style>
    :root { --bg:#0f0a1a; --card:#1a0d33; --accent:#6a1b9a; --text:#e0d0ff; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:Arial; min-height:100vh; }
    header { background:var(--accent); padding:20px; text-align:center; font-size:1.8rem; font-weight:bold; }
    .tap-target { -webkit-tap-highlight-color: transparent; user-select: none; }
    .search-bar { padding:15px; text-align:center; }
    #search { width:90%; max-width:500px; padding:12px; background:var(--card); color:var(--text); border:none; border-radius:30px; font-size:1rem; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:15px; padding:20px; }
    .card { background:var(--card); border-radius:12px; overflow:hidden; cursor:pointer; transition:0.3s; position:relative; }
    .card:hover { transform:scale(1.05); box-shadow:0 5px 15px rgba(106,27,154,0.4); }
    .card img { width:100%; height:200px; object-fit:cover; }
    .info { padding:10px; text-align:center; }
    .info h3 { font-size:0.95rem; margin:5px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .info p { font-size:0.8rem; color:#bbb; }
    .badge { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:#0f0; padding:3px 8px; border-radius:12px; font-size:0.7rem; font-weight:bold; }
    .admin-panel { display:none; background:var(--card); padding:20px; border-radius:16px; margin:20px auto; max-width:700px; }
    .admin-panel.active { display:block; }
    textarea { width:100%; padding:12px; background:#222; color:var(--text); border:none; border-radius:8px; font-size:1rem; margin:10px 0; }
    button { background:var(--accent); color:white; padding:12px 24px; border:none; border-radius:50px; cursor:pointer; font-size:1rem; margin:5px; }
    #status { margin:15px 0; font-weight:bold; color:#00ff88; }
    .download { background:#333; color:#0f0; padding:10px; border-radius:8px; margin:10px 0; }
  </style>
</head>
<body>

  <header>
    <h1 class="tap-target" id="titleTap">S0oxFlix</h1>
  </header>

  <div class="search-bar">
    <input type="text" id="search" placeholder="Rechercher un film..." />
  </div>

  <div class="grid" id="films"></div>

  <div class="admin-panel" id="adminPanel">
    <h2>Créer un film (.html)</h2>
    <p>Colle <strong>le code iframe complet</strong> → Génère un fichier .html</p>
    <textarea id="iframeInput" rows="5" placeholder='<iframe src="https://vidsrc-embed.ru/embed/movie?tmdb=569094" ...></iframe>'></textarea>
    <button onclick="generateFilmFile()">Générer le fichier .html</button>
    <div id="status"></div>
    <div id="downloadArea" class="download" style="display:none;"></div>
  </div>

  <script>
    let films = [];
    let tapCount = 0;
    let tapTimer;

    // === FILMS (à remplir manuellement) ===
    films = [
      // Ex: { title: "Spider-Man: No Way Home", year: "2021", poster: "...", file: "nowayhome.html" }
    ];

    function renderFilms() {
      const grid = document.getElementById('films');
      grid.innerHTML = '';
      if (!films.length) {
        grid.innerHTML = '<p style="text-align:center;color:#aaa;padding:40px;">Aucun film (upload des .html)</p>';
        return;
      }
      films.forEach(f => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${f.poster}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
          <div class="info"><h3>${f.title}</h3><p>${f.year}</p></div>
        `;
        card.onclick = () => window.location.href = f.file;
        grid.appendChild(card);
      });
    }

    // === ADMIN (3 taps) ===
    document.getElementById('titleTap').addEventListener('click', () => {
      tapCount++;
      clearTimeout(tapTimer);
      tapTimer = setTimeout(() => tapCount = 0, 1000);
      if (tapCount === 3) {
        tapCount = 0;
        const pwd = prompt('Mot de passe admin :');
        if (pwd === 'S0ox2025') {
          document.getElementById('adminPanel').classList.add('active');
        }
      }
    });

    // === GÉNÉRER FICHIER .HTML (FIX ID TMDB) ===
    window.generateFilmFile = async function() {
      const input = document.getElementById('iframeInput').value.trim();
      if (!input.includes('<iframe')) return alert('Colle un code iframe complet !');

      const srcMatch = input.match(/src=["']([^"']+)["']/);
      if (!srcMatch) return alert('Lien non trouvé dans l’iframe');

      const embedUrl = srcMatch[1];

      // FIX : Accepte ?tmdb= ET /tmdb/
      const tmdbMatch = embedUrl.match(/(?:tmdb[=/])(\d+)/);
      if (!tmdbMatch) return alert('ID TMDB manquant ! Vérifie le lien.');

      const tmdbId = tmdbMatch[1];
      const isTV = embedUrl.includes('/tv/') || embedUrl.includes('tv');
      const type = isTV ? 'tv' : 'movie';

      try {
        const res = await fetch(`https://api.themoviedb.org/3/${type}/${tmdbId}?api_key=15d2ea6d0dc1d476efbca3eba2b9bbfb&language=fr`);
        const media = await res.json();

        if (!media.title && !media.name) throw new Error('Film non trouvé');

        const title = (media.title || media.name).replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const year = (media.release_date || media.first_air_date)?.slice(0,4) || '0000';
        const filename = `${title}_${year}.html`;

        const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>${media.title || media.name} (${year}) - S0oxFlix</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; }
    iframe { width:100%; height:100%; border:none; }
    .back { position:fixed; top:10px; left:10px; background:rgba(0,0,0,0.7); color:white; padding:10px 15px; border-radius:50px; text-decoration:none; font-family:Arial; z-index:999; font-size:0.9rem; }
  </style>
</head>
<body>
  <a href="index.html" class="back">Retour</a>
  ${input}
</body>
</html>`;

        // Téléchargement
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);

        // Ajouter à la liste
        films.push({
          title: media.title || media.name,
          year: year,
          poster: `https://image.tmdb.org/t/p/w500${media.poster_path}`,
          file: filename
        });
        renderFilms();

        document.getElementById('status').innerHTML = `Fichier <strong>${filename}</strong> généré ! Upload-le sur Netlify.`;
        document.getElementById('downloadArea').style.display = 'block';
        document.getElementById('downloadArea').innerHTML = `Télécharge <code>${filename}</code> → Upload sur Netlify → Film live !`;

      } catch (e) {
        alert('Erreur : ' + (e.message || 'TMDB ou connexion'));
      }
    };

    // === RECHERCHE ===
    document.getElementById('search').addEventListener('input', () => {
      const q = document.getElementById('search').value.trim().toLowerCase();
      const filtered = films.filter(f => f.title.toLowerCase().includes(q));
      renderFilms(filtered);
    });

    renderFilms();
  </script>
</body>
</html>
